function Get-CISM365Control_2_5_1 {
    [OutputType([hashtable])]
    param()

    @{
        Id          = '2.5.1'
        Name        = "Ensure Anti-malware policies apply to all users and domains"
        Profile     = 'L1'
        Automated   = $true
        Services    = @('ExchangeOnline')
        Description = "Anti-malware policies should be assigned to all relevant recipients (users, groups, domains) for complete coverage."
        Rationale   = "Ensures all users and domains are protected by anti-malware scanning."
        References  = @(
            'https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/anti-malware-policies-configure?view=o365-worldwide'
        )
        Audit       = {
            try {
                $policies = Get-MalwareFilterPolicy
                $rules = Get-MalwareFilterRule
                $allRecipients = (Get-Mailbox -ResultSize Unlimited | Select-Object -ExpandProperty UserPrincipalName)
                $coveredRecipients = @()
                foreach ($rule in $rules) {
                    $coveredRecipients += $rule.Recipients
                }
                $notCovered = $allRecipients | Where-Object { $coveredRecipients -notcontains $_ }
                if ($notCovered.Count -eq 0) {
                    "PASS (Anti-malware policies cover all recipients and domains)"
                } else {
                    "FAIL (Recipients not covered by anti-malware policy: $($notCovered -join ', '))"
                }
            }
            catch {
                "MANUAL (Unable to check anti-malware policy coverage: $($_.Exception.Message))"
            }
        }
    }
}