# Private/Controls/Control-1.3.4.ps1
function Get-CISM365Control_1_3_4 {
    [OutputType([hashtable])]
    param()
    @{ Id='1.3.4'; Name="Ensure 'User owned apps and services' is restricted"; Profile='L1'; Automated=$false; Services=@('AdminCenter'); Description='Disable users ability to install Office Store add-ins and prevent starting 365 trials on behalf of the organization.'; Rationale='Preventing self-installed add-ins and trials reduces the risk of data exposure via unvetted third-party apps.'; References=@('https://admin.microsoft.com (Microsoft 365 admin center – Settings → Org settings → User owned apps and services)','CIS Microsoft 365 Foundations Benchmark'); Audit={ try { try { if (-not (Get-Command -Name Get-CurrentTenant -ErrorAction SilentlyContinue)) { $scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path; $candidate = Join-Path $scriptDir '..\..\Helpers\Get-CurrentTenant.ps1'; $resolved = Resolve-Path -Path $candidate -ErrorAction SilentlyContinue; if ($resolved) { . $resolved.ProviderPath } } } catch {}; $steps = @("1. Sign in to Microsoft 365 admin center: https://admin.microsoft.com","2. In the left nav expand Settings and choose 'Org settings'","3. Under Services select 'User owned apps and services'","4. Verify 'Let users access the Office Store' and 'Let users start trials on behalf of your organization' are NOT checked"); return "MANUAL: Verify via admin center that the two options are NOT checked.`nAudit steps:`n$($steps -join "`n")" } catch { return "ERROR: $($_.Exception.Message)" } } }
}